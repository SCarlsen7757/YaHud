@page "/"
@implements IDisposable
@inject ShortcutService ShortcutClientService
@inject HudLockService HudLockService
@inject VisibilityService VisibilityService
@inject TestModeService TestModeService
@inject SettingsService SettingsService
@using R3E.API
@using R3E.YaHud.Components.Widget.RelativeDriver
@using R3E.YaHud.Services
@using R3E.YaHud.Services.Settings
@using R3E.YaHud.Components.UI.Components
@using R3E.YaHud.Components.Widget
@using R3E.YaHud.Components.Widget.Clock
@using R3E.YaHud.Components.Widget.MoTec
@using R3E.YaHud.Components.Widget.FuelGauge
@using R3E.YaHud.Components.Widget.UserInputs
@using R3E.YaHud.Components.Widget.StartLight

@if (!locked)
{
    <div class="icon-button-stack">
        <button class="icon-button" @onclick="ShowSettings">
            <svg>
                <Icon Name="gear" />
            </svg>
        </button>

        <button class="icon-button @(!WidgetsVisible ? "active" : "")" @onclick="ToggleWidgetVisibility">
            <svg>
                <Icon @key='@WidgetsVisible' Name="@VisibilityIcon" />
            </svg>
        </button>

        <button disabled="@(!WidgetsVisible)" class="icon-button @(testMode ? "active" : "")" @onclick="ToggleTestMode">
            <svg>
                <Icon @key="testMode" Name="@TestModeIcon" />
            </svg>
        </button>

        <button class="icon-button" @onclick="ShowAbout">
            <svg>
                <Icon Name="info" />
            </svg>
        </button>
    </div>
}

@if (showSettings)
{
    <SettingsPanel Widgets="SettingsService.Widgets" OnClose="HideSettings" />
}

@if (showAbout)
{
    <About OnClose="HideAbout" />
}

<!-- Widgets are always in the DOM but hidden via CSS based on visibility state -->
<div style="display: @(WidgetsVisible ? "block" : "none");">
    <Clock />
    <MoTec />
    <UserInputs />
    <Fuel />
    <StartLight />
    <RelativeDriver />
</div>

@code {
    private bool showSettings = false;
    private bool showAbout = false;
    private bool locked;
    private bool testMode;

    private bool WidgetsVisible => VisibilityService.WidgetsVisible;
    private string VisibilityIcon => WidgetsVisible ? "eye" : "eye-slash";
    private string TestModeIcon => testMode ? "flask-vial" : "flask";

    protected override async Task OnInitializedAsync()
    {
        HudLockService.OnLockChanged += LockChanged;
        VisibilityService.OnVisibilityChanged += VisibilityChanged;
        TestModeService.OnTestModeChanged += TestModeChanged;
        locked = HudLockService.Locked;
        testMode = TestModeService.TestMode;

        await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Eagerly load global settings once when JS is ready
            // This ensures settings are available before any widget tries to access them
            await SettingsService.LoadGlobalSettings();
        }
    }

    private void ShowSettings()
    {
        showSettings = true;
        InvokeAsync(StateHasChanged);
    }

    private async Task HideSettings()
    {
        await SettingsService.SaveAll();
        showSettings = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task ToggleWidgetVisibility()
    {
        if (WidgetsVisible) await SettingsService.SaveAll();

        VisibilityService.ToggleVisibility();
        if (!WidgetsVisible) TestModeService.SetTestMode(false);
        await InvokeAsync(StateHasChanged);
    }

    private async Task ShowAbout()
    {
        showAbout = true;
        await InvokeAsync(StateHasChanged);
    }

    private async void HideAbout()
    {
        showAbout = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task ToggleTestMode()
    {
        TestModeService.ToggleTestMode();
        await InvokeAsync(StateHasChanged);
    }

    private void VisibilityChanged(bool isVisible)
    {
        InvokeAsync(StateHasChanged);
    }

    private void TestModeChanged(bool isTestMode)
    {
        testMode = isTestMode;
        InvokeAsync(StateHasChanged);
    }

    private async void LockChanged(bool locked)
    {
        if (locked)
        {
            await HideSettings();
            HideAbout();
        }
        this.locked = locked;
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        HudLockService.OnLockChanged -= LockChanged;
        VisibilityService.OnVisibilityChanged -= VisibilityChanged;
        TestModeService.OnTestModeChanged -= TestModeChanged;
    }
}