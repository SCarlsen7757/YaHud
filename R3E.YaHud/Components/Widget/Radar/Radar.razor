@using R3E.YaHud.Components.UI.Helpers
@using R3E.YaHud.Components.Widget.Core
@using R3E.YaHud.Components.Widget.MoTec.Components
@using R3E.API
@using System.Numerics
@using System.Globalization
@inherits HudWidgetBase<RadarSettings>

@if (Settings?.Visible ?? false)
{
    <div id=@ElementId class="radar-widget">
        <div id="radar" @ref="radarElement" style="@RadarStyling.ToString()">
            @foreach (var child in activeDriverSlots)
            {
                <div id="@child" class="@driverStyling.GetValueOrDefault(child)!.Classes.ToString()" style="@driverStyling.GetValueOrDefault(child)!.ToString()">

                </div>
            }
        </div>
    </div>
}


@code {

    public override string ElementId { get => "radarWidget"; }
    public override string Name => "Radar";
    public override string Category => "Telemetry";
    public override bool Collidable => false;

    public override double DefaultXPercent => 90;
    public override double DefaultYPercent => 90;
    private static readonly string RadarGridImagePath = $"assets/img/radar/radar-grid.png";
    private readonly StylingElement RadarStyling = new StylingElement();

    private Dictionary<int, DriverState> drivers = new Dictionary<int, DriverState>();
    private List<int> activeDriverSlots = new List<int>();
    private readonly Dictionary<int, StylingElement> driverStyling = new Dictionary<int, StylingElement>();
    private bool RadarPointer = true;
    private ElementReference radarElement;
    private double radarWidth;
    private DateTime lastAlertUtc = DateTime.MinValue;
    private TimeSpan alertCooldown = new TimeSpan(0, 0, 0, 0, 200);
    private readonly double pointerStartRangeFactor = 1.1;
    private readonly double opacityPowerFactor = 0.5;
    private readonly int ordinalTranslateVertialOffset = 150; // Vertical offset in px to position ordinal labels relative to the radar center (tuned for the base radar dimensions)

    public Radar()
    {
        RadarStyling.SetStyle("background-image", $"radial-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.4) ), url({RadarGridImagePath})");
        UseR3EData = true;
        UpdateInterval = TimeSpan.FromMilliseconds(30);
    }

    protected override void UpdateWithTestData()
    {
        activeDriverSlots.Clear();
        driverStyling.Clear();

        RadarStyling.SetStyle("opacity", Fmt(1));
        var driverCloseRightImg = "assets/img/radar/radar-grid-warning-right.png";
        RadarStyling.AppendStyleString("background-image", $",url({driverCloseRightImg})");

        activeDriverSlots.Add(0);
        var se = new StylingElement();
        se.Classes.Add("radar-car");
        se.Classes.Add("radar-car-self");
        se.SetStyle("width", FmtPx(16.605));
        se.SetStyle("height", FmtPx(37.899));
        se.SetStyle("translate", "none");
        se.SetStyle("transform", "translate3d(91.69718px,81.05032px,0) rotate(0rad);");
        se.SetStyle("opacity", "1");
        driverStyling[0] = se;

        activeDriverSlots.Add(1);
        var se2 = new StylingElement();
        se2.Classes.Add("radar-car");
        se2.SetStyle("width", FmtPx(16.416));
        se2.SetStyle("height", FmtPx(33.306));
        se2.SetStyle("translate", "none");
        se2.SetStyle("transform", "translate3d(137.726px,51.27176px,0) rotate(0.004727272443771362305rad);");
        se2.SetStyle("opacity", "1");
        driverStyling[1] = se2;

        activeDriverSlots.Add(2);
        var se3 = new StylingElement();
        se3.Classes.Add("radar-car");
        se3.SetStyle("width", FmtPx(15.899));
        se3.SetStyle("height", FmtPx(38.949));
        se3.SetStyle("translate", "none");
        se3.SetStyle("transform", "translate3d(70.538px,129.28278px,0) rotate(-0.03006303310394287rad);");
        se3.SetStyle("opacity", "1");
        driverStyling[2] = se3;

        if (Settings.RadarBeeping && (DateTime.UtcNow - lastAlertUtc) >= alertCooldown)
        {
            _ = PlayAlert(1 - 4 / Settings.RadarRange, 0 * -1 + 1 * 1);
            lastAlertUtc = DateTime.UtcNow;
        }

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (firstRender && radarElement.Context != null)
        {
            radarWidth = await JS.InvokeAsync<double>(
                "radarInterop.getOffsetWidth",
                radarElement
            );
            // preload an effect file (wwwroot/assets/sounds/alert.mp3)
            _ = JS.InvokeVoidAsync("audioControllerManager.create", "alert", new { soundFile = "assets/sounds/radar/beep.wav" });
            _ = JS.InvokeVoidAsync("audioControllerManager.preload", "alert", "assets/sounds/radar/beep.wav");
            // optionally unlock on first user gesture
            _ = JS.InvokeVoidAsync("audioControllerManager.unlockAudioOnGestureOnce");
            StateHasChanged();
        }

    }

    protected override void Update()
    {
        if (Settings is null) return;
        R3E.Data.Shared data = TelemetryService.Data.Raw;
        if (data.DriverData == null)
            return;

        alertCooldown = new TimeSpan(0, 0, 0, 0, Settings.BeepingInterval);

        foreach (var driver in data.DriverData)
        {
            drivers.TryAdd(driver.DriverInfo.SlotId, new DriverState());
        }

        var rotationMatrix = RotationMatrixFromEuler(data.Player.Orientation);
        var pointerStartRange = Settings.RadarRange * pointerStartRangeFactor;
        var radarFadeRange = Settings.RadarRange + Settings.RadarFadeRange;

        var ownDriverCandidates = data.DriverData
            .Where(d => d.DriverInfo.UserId == data.Player.UserId)
            .ToList();
        if (ownDriverCandidates.Count == 0)
            return;
        var ownDriver = ownDriverCandidates[0];

        var ownPlace = ownDriver.Place;

        var speed = MpsToKph(ownDriver.CarSpeed);

        foreach (var driver in data.DriverData)
        {
            var slot = driver.DriverInfo.SlotId;
            if (ownPlace != driver.Place)
            {
                drivers[slot].RelativePos = RotateVector(rotationMatrix, SubtractVector(ownDriver.Position, driver.Position));
                var tmp = SubtractVector(driver.Orientation, ownDriver.Orientation);
                drivers[slot].RelativeOri = new Vector3(tmp.X, tmp.Y, tmp.Z);
            }
            drivers[slot].DriverData = driver;
        }

        var closeBySlot = drivers
            .Where(kvp => DistanceFromZero(kvp.Value.RelativePos) < radarFadeRange)
            .ToDictionary(kvp => kvp.Key, kvp => kvp.Value);

        double? closest = null;
        int closeLeft = 0;
        int closeRight = 0;

        foreach (var kv in drivers)
        {
            var slotId = kv.Key;
            if (!activeDriverSlots.Contains(slotId))
                activeDriverSlots.Add(slotId);
            if (!driverStyling.ContainsKey(slotId))
            {
                var se = new StylingElement();
                se.SetStyle("display", "none");
                se.Classes.Add("radar-car");
                driverStyling[slotId] = se;
            }
        }

        foreach (var childSlotId in activeDriverSlots)
        {
            if (!closeBySlot.TryGetValue(childSlotId, out var state))
            {
                if (driverStyling.TryGetValue(childSlotId, out var stylingHidden))
                {
                    stylingHidden.SetStyle("display", "none");
                    driverStyling[childSlotId] = stylingHidden;
                }
                else
                {
                    var hidden = new StylingElement();
                    hidden.SetStyle("display", "none");
                    hidden.Classes.Add("radar-car");
                    driverStyling[childSlotId] = hidden;
                }

                continue;
            }

            if (!driverStyling.TryGetValue(childSlotId, out var child))
            {
                child = new StylingElement();
                child.Classes.Add("radar-car");
                child.SetStyle("display", "none");
                driverStyling[childSlotId] = child;
            }

            var driverState = state;
            var driverRotation = driverState.RelativeOri.Y;
            var driverLeftRight = driverState.RelativePos.X;
            var driverFrontBack = driverState.RelativePos.Z;

            var carWidth = (double)driverState.DriverData.DriverInfo.CarWidth;
            var carLength = (double)driverState.DriverData.DriverInfo.CarLength;

            var distance = DistanceFromZero(driverState.RelativePos);

            if (distance < Settings.RadarRange)
            {
                if (driverLeftRight < 0 && IsCarClose(driverFrontBack, driverLeftRight, carLength))
                    closeLeft = 1;
                else if (driverLeftRight > 0 && IsCarClose(driverFrontBack, driverLeftRight, carLength))
                    closeRight = 1;
            }

            driverFrontBack = -driverFrontBack;

            var width = carWidth / Settings.RadarRange * radarWidth / 2;
            var height = carLength / Settings.RadarRange * radarWidth / 2;

            string transformStr;
            string opacityStr;

            if (RadarPointer && distance > pointerStartRange)
            {
                var pointerRotation = GetRadarPointerRotation(distance, driverState.RelativePos.X, driverState.RelativePos.Z);
                var fadeDenominator = Settings.RadarRange - radarFadeRange;
                double pointerOpacity;
                if (fadeDenominator > 0)
                {
                    pointerOpacity = Math.Pow((distance - radarFadeRange) / fadeDenominator, opacityPowerFactor);
                }
                else
                {
                    // Fallback to fully visible pointer if configuration would cause division by zero
                    pointerOpacity = 1.0;
                }

                child.SetStyle("display", null);
                child.SetStyle("background-color", "red");
                child.SetStyle("border-radius", "0px");
                child.SetStyle("width", FmtPx(width));
                child.SetStyle("height", "20px");
                child.SetStyle("translate", "-50% -50%");
                transformStr = driverState.RelativePos.Z > 0 ? $"rotate({Fmt(pointerRotation)}rad) translate3d(0px,-{FmtPx(ordinalTranslateVertialOffset)},0px)" : $"rotate({Fmt(pointerRotation)}rad) translate3d(0px,{FmtPx(ordinalTranslateVertialOffset)},0px)";
                child.SetStyle("transform", transformStr);
                opacityStr = Fmt(pointerOpacity);
                child.SetStyle("opacity", opacityStr);

                driverStyling[childSlotId] = child;
            }
            else
            {
                var leftVal = (driverLeftRight / Settings.RadarRange) * radarWidth / 2 + radarWidth / 2 - width / 2;
                var topVal = (driverFrontBack / Settings.RadarRange) * radarWidth / 2 + radarWidth / 2 - height / 2;

                transformStr = $"translate3d({FmtPx(leftVal)},{FmtPx(topVal)},0) rotate({Fmt(driverRotation)}rad)";

                child.SetStyle("display", null);
                child.SetStyle("background-color", ownPlace == driverState.DriverData.Place ? "white" : "red");
                child.SetStyle("border-radius", "6px");

                if (!Settings.Use3DTranslate){
                    child.SetStyle("left", FmtPx(leftVal));
                    child.SetStyle("top", FmtPx(topVal));
                    child.SetStyle("transform", $"rotate({Fmt(driverRotation)}rad)");
                }

                child.SetStyle("width", FmtPx(width));
                child.SetStyle("height", FmtPx(height));

                child.SetStyle("translate", "none");
                if (Settings.Use3DTranslate)
                    child.SetStyle("transform", $"{transformStr}");
                child.SetStyle("opacity", "1");

                driverStyling[childSlotId] = child;
           }

            if (ownDriver.DriverInfo.SlotId == driverState.DriverData.DriverInfo.SlotId)
            {
                child.Classes.Add("radar-car-self");
                driverStyling[childSlotId] = child;
            }
            else
            {
                if (closest == null || distance < closest)
                    closest = distance;

                child.Classes.Remove("radar-car-self");
                driverStyling[childSlotId] = child;
            }
        }

        const string driverCloseLeftImg = "assets/img/radar/radar-grid-warning-left.png";
        const string driverCloseRightImg = "assets/img/radar/radar-grid-warning-right.png";

        if (closeLeft == 1)
        {
            RadarStyling.AppendStyleString("background-image", $",url({driverCloseLeftImg})");
        }
        else
        {
            RadarStyling.RemoveStyleString("background-image", $",url({driverCloseLeftImg})");
        }
        if (closeRight == 1)
        {
            RadarStyling.AppendStyleString("background-image", $",url({driverCloseRightImg})");
        }
        else
        {
            RadarStyling.RemoveStyleString("background-image", $",url({driverCloseRightImg})");
        }

        if (Settings.RadarBeeping && (closeLeft == 1 || closeRight == 1) && speed >= Settings.MinBeepSpeed && closest.HasValue)
        {
            if ((DateTime.UtcNow - lastAlertUtc) >= alertCooldown)
            {
                var proximity = 1 - closest.Value / Settings.RadarRange;
                _ = PlayAlert(proximity, closeLeft * -1 + closeRight * 1);
                lastAlertUtc = DateTime.UtcNow;
            }

        }


        if (Settings.AutoHideRadar)
        {
            if (closest == null || closest > radarFadeRange)
            {
                RadarStyling.SetStyle("opacity","0");
                return;
            }

            double opacityValue;
            if (Settings.RadarRange <= radarFadeRange)
            {
                opacityValue = closest.Value < Settings.RadarRange ? Settings.RadarOpacity : 0;
            }
            else
            {
                opacityValue = closest.Value < Settings.RadarRange
                    ? Settings.RadarOpacity
                    : ((closest.Value - radarFadeRange) / (Settings.RadarRange - radarFadeRange)) * Settings.RadarOpacity;
            }

            RadarStyling.SetStyle("opacity",Fmt(opacityValue));
        }
    }

    private static bool IsCarClose(double frontBack, double leftRight, double length)
    {
        var absFrontBack = Math.Abs(frontBack);
        var absLeftRight = Math.Abs(leftRight);
        return absFrontBack < absLeftRight || absFrontBack <= length;
    }

    private static double[,] RotationMatrixFromEuler(R3E.Data.Vector3<Double> euler)
    {
        double x = -euler.X;
        double y = -euler.Y;
        double z = -euler.Z;

        double c1 = Math.Cos(x);
        double s1 = Math.Sin(x);
        double c2 = Math.Cos(y);
        double s2 = Math.Sin(y);
        double c3 = Math.Cos(z);
        double s3 = Math.Sin(z);

        return new double[,]
        {
            { c2 * c3, -c2 * s3, s2 },
            { c1 * s3 + c3 * s1 * s2, c1 * c3 - s1 * s2 * s3, -c2 * s1 },
            { s1 * s3 - c1 * c3 * s2, c3 * s1 + c1 * s2 * s3, c1 * c2 }
        };
    }

    public static Vector3 RotateVector<T>(double[,] matrix, R3E.Data.Vector3<T> vector) where T : struct, IConvertible
    {
        double vx = Convert.ToDouble(vector.X, CultureInfo.InvariantCulture);
        double vy = Convert.ToDouble(vector.Y, CultureInfo.InvariantCulture);
        double vz = Convert.ToDouble(vector.Z, CultureInfo.InvariantCulture);
        float x = (float)(matrix[0, 0] * vx + matrix[0, 1] * vy + matrix[0, 2] * vz);
        float y = (float)(matrix[1, 0] * vx + matrix[1, 1] * vy + matrix[1, 2] * vz);
        float z = (float)(matrix[2, 0] * vx + matrix[2, 1] * vy + matrix[2, 2] * vz);

        return new Vector3(x, y, z);
    }

    public static R3E.Data.Vector3<float> SubtractVector(R3E.Data.Vector3<float> a, R3E.Data.Vector3<float> b)
    {
        return new R3E.Data.Vector3<float>
        {
            X = a.X - b.X,
            Y = a.Y - b.Y,
            Z = a.Z - b.Z
        };
    }

    public double DistanceFromZero(Vector3 v)
    {
        return Math.Sqrt(v.X * v.X + v.Z * v.Z);
    }

    public static double GetRadarPointerRotation(double d, double x, double z)
    {
        double angle = Math.Acos(Math.Abs(z) / d);

        if (x > 0 && z > 0)
        {
            return angle;
        }
        else if (x > 0 && z < 0)
        {
            return -angle;
        }
        else if (x < 0 && z > 0)
        {
            return -angle;
        }
        else
        {
            return angle;
        }
    }

    public static double MpsToKph(Single mps)
    {
        return mps * 3.6;
    }

    private static string Fmt(double v) =>
        v.ToString("G", CultureInfo.InvariantCulture);

    private static string FmtPx(double v) =>
        Fmt(v) + "px";
    
    
    private Task PlayAlert(double amount, double pan)
    {
        return JS.InvokeVoidAsync("audioControllerManager.play", "alert", amount, pan).AsTask();
    }
}
