@using R3E.YaHud.Components.Widget.Core
@using R3E.API
@using System.Drawing
@using System.Runtime.InteropServices
@using System.Diagnostics.Eventing.Reader
@using static R3E.Constant
@inherits HudWidgetBase<FuelSettings>

@if (Settings?.Visible ?? false)
{
    <div id=@ElementId class="Fuel-widget">
        <div class="data-grid">
            <div class="data-box large-box">
                <p class="value"style="color: @FRColor"> @(FuelRemaining.ToString("F1"))</p>
                <div class="label">Fuel Remaining</div>
            </div>

            <div class="data-box">
                <p class="value"style="color: @TELColor">@sTimeEstimatedLeft</p>
                <div class="label">Time Estimated</div>
            </div>

            <div class="data-box">
                <p class="value"style="color: rgb(127, 127, 43)">@(LastLapFuelUsage.ToString("F1"))</p>
                <div class="label">Last Lap</div>
            </div>
            
            <div class="data-box large-box">
                <p class="value"style="color: @FTEColor">@(FuelToEnd.ToString("F1"))</p>
                <div class="label">Fuel to End</div>
            </div>

            <div class="data-box large-box">
                <p class="value"style="color: rgb(0, 128, 0)">@(FuelToAdd.ToString("F1"))</p>
                <div class="label">Fuel to Add</div>
            </div>

            <div class="data-box">
                <p class="value"style="color: rgb(0, 128, 0)">@(LapsEstimatedLeft.ToString("F1"))</p>
                <div class="label">Laps Estimated</div>
            </div>

            <div class="data-box">
                <p class="value"style="color: rgb(127, 127, 43)">@(FuelPerLap.ToString("F1"))</p>
                <div class="label">Fuel per Lap</div>
            </div>
        </div>
    </div>
}

@code {
    private float FuelRemaining { get; set; } = 0.0f;
    private string FRColor { get; set; } = "rgb(0, 128, 0)";
    private float FRColorSwitch { get; set; } = 0.0f;
    private int TimeEstimatedLeft { get; set; } = 0;
    private string sTimeEstimatedLeft { get; set; } = "0";
    private string TELColor { get; set; } = "rgb(0, 128, 0)";
    private float LapsEstimatedLeft { get;  set; } = 0.0f;
    private float LastLapFuelUsage { get; set; } = 0.0f;
    private float FuelPerLap { get; set; } = 0.0f;
    private float FuelToEnd { get; set; } = 0.0f;
    private string FTEColor { get; set; } = "rgb(0, 128, 0)";
    private float FTEColorSwitch { get; set; } = 0.0f;
    private float FuelToAdd { get;  set; } = 0.0f;
    private float FuelCapacity { get;  set; } = 0.0f;
    private int NumberOfLaps { get;  set; } = 0;
    private int oldNumberOfLaps = 0;
    private float oldFuelRemaining = 0.0f;
    private int SessionPhase = -1;
    private SessionLengthFormat SessionLengthFormat = SessionLengthFormat.Unavailable;
    public override string ElementId { get => "FuelWidget"; }
    public override string Name => "Fuel";
    public override string Category => "Telemetry";
    public override double DefaultXPercent => 50;
    public override double DefaultYPercent => 50;
    public override bool Collidable => true;

    public Fuel()
    {
        UseR3EData = true;
        UpdateInterval = TimeSpan.FromMilliseconds(30);
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        TelemetryService.NewLap += OnNewLap;
    }

    private void OnNewLap(TelemetryData newData)
    {
        //Everytime we pass raceline NumberOfLaps should update so we use this as a trigger to calculate the remaining variables 
        LastLapFuelUsage = oldFuelRemaining - FuelRemaining;
        oldFuelRemaining = FuelRemaining;
    }


    public override void Dispose()
    {
        TelemetryService.NewLap -= OnNewLap; 
    }

    protected override void Update()
    {
        R3E.Data.Shared data = TelemetryService.Data.Raw;

        //Start mapping of variables  
        SessionPhase = data.SessionPhase;
        FuelRemaining = data.FuelLeft;
        TimeEstimatedLeft = (int)data.SessionTimeRemaining;
        FuelPerLap = data.FuelPerLap;
        LapsEstimatedLeft = data.FuelLeft / data.FuelPerLap;
        SessionLengthFormat = (SessionLengthFormat)data.SessionLengthFormat;


        //Start calculating rest of variables from mapped variables
        //Only on countdown - map the following varibales as a "oneshot" so it doesn't occur throughout the race
        if (SessionPhase == 4)
        {
            oldFuelRemaining = FuelRemaining;
            oldNumberOfLaps = data.NumberOfLaps;
            FuelCapacity = data.FuelCapacity;
        }

        //Based on the Session Format change the calculations
        switch (SessionLengthFormat)
        {
            case SessionLengthFormat.Unavailable:
                ; //Nothing to calculate
                break;

            // TimeBased
            case SessionLengthFormat.TimeBased: 
                FuelToEnd = (FuelPerLap / data.LapTimeCurrentSelf) * TimeEstimatedLeft;
                FuelToAdd =  Math.Min(FuelToEnd - FuelRemaining, data.FuelCapacity - FuelRemaining); 
                Console.WriteLine(data.LapTimeCurrentSelf);

                break;

            // LapBased
            case SessionLengthFormat.LapBased:
                FuelToEnd = data.NumberOfLaps / data.FuelPerLap;
                FuelToAdd =  Math.Min(FuelToEnd - FuelRemaining, data.FuelCapacity - FuelRemaining); 
                break;

            // TimeAndLapBased - Time and lap based session means there will be an extra lap after the time has run out
            case SessionLengthFormat.TimeAndLapBased:
                FuelToEnd = (data.NumberOfLaps+1) / data.FuelPerLap;
                FuelToAdd =  Math.Min(FuelToEnd - FuelRemaining, data.FuelCapacity - FuelRemaining);       
                break;
        }  


        FRColorSwitch = FuelRemaining / (FuelCapacity / 100);
        if (FRColorSwitch >= 50.0)
        {
            FRColor = Settings.green; 
        }   
        else if  (50.0 > FRColorSwitch && FRColorSwitch >= 35.0)
        {
            FRColor = Settings.yellow; 
        }
        else if  (35.0 > FRColorSwitch && FRColorSwitch >= 15.0)
        {
            FRColor = Settings.orange; 
        }
        else if  (15.0 > FRColorSwitch && FRColorSwitch >= 0.0)
        {
            FRColor = Settings.red; 
        }
        if (FuelToEnd < FuelRemaining)
        {
            FTEColor = Settings.green; 
        }   
        else 
        {
            FTEColor = Settings.red; 
        }
        //ready variables for text to round or change format so it can be shown correctly

        TimeSpan t = TimeSpan.FromSeconds(TimeEstimatedLeft);
        if(t.Hours >= 1) 
        {
            sTimeEstimatedLeft = t.ToString(@"hh\:mm");
            TELColor = Settings.green; 
        }
        else if(t.Minutes >= 1)
        {
            sTimeEstimatedLeft = t.ToString(@"mm\:ss");
            TELColor = Settings.orange; 
        }
        else
        {
            sTimeEstimatedLeft = t.ToString(@"ss");
            TELColor = Settings.red; 
        }
    }

    protected override void UpdateWithTestData()
    {
        //TODO: Add test data
    }
}