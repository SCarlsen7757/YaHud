@using R3E.YaHud.Components.Widget.Core
@using R3E.API
@using static R3E.Constant
@inherits HudWidgetBase<FuelSettings>

@if (Settings.Visible)
{
    <div id=@ElementId class="Fuel-widget text">
        <p class="FuelRemaining-text">@FuelRemaining</p>
        <p class="TimeEstimatedLeft-text">@TimeEstimatedLeft</p>
        <p class="LapsEstimatedLeft-text">@LapsEstimatedLeft</p>
        <p class="LastLapFuelUsage-text">@LastLapFuelUsage</p>
        <p class="FuelPerLap-text">@FuelPerLap</p>
        <p class="FuelToEnd-text">@FuelToEnd</p>
        <p class="FuelToAdd-text">@FuelToAdd</p>
    </div>
}

@code {
    private float FuelRemaining { get; set; } = 0.0f;
    private float TimeEstimatedLeft { get; set; } = 0.0f;
    private float LapsEstimatedLeft { get;  set; } = 0.0f;
    private float LastLapFuelUsage { get; set; } = 0.0f;
    private float FuelPerLap { get; set; } = 0.0f;
    private float FuelToEnd { get; set; } = 0.0f;
    private float FuelToAdd { get;  set; } = 0.0f;
    private int NumberOfLaps { get;  set; } = 0;
    private int oldNumberOfLaps = 0;
    private float oldFuelRemaining = 0.0f;
    private int SessionPhase = -1;
    private SessionLengthFormat SessionLengthFormat = SessionLengthFormat.Unavailable;
    


    private string RpsBarBackgroundColor => "#454545";
    private string RpsCurrentColor { get; set; } = "#ffffff";

    public override string ElementId { get => "FuelWidget"; }
    public override string Name => "Fuel";
    public override string Category => "Telemetry";

    public override double DefaultXPercent => 50;
    public override double DefaultYPercent => 50;


    public Fuel()
    {
        UseR3EData = true;
        UpdateInterval = TimeSpan.FromMilliseconds(30);
        TelemetryService.NewLap += OnNewLap;
    }

    private void OnNewLap(TelemetryData newData)
    {
        //Everytime we pass raceline NumberOfLaps should update so we use this as a trigger to calculate the remaining variables 
        LastLapFuelUsage = oldFuelRemaining - FuelRemaining;
        oldFuelRemaining = FuelRemaining;
    }


    public override void Dispose()
    {
       TelemetryService.NewLap -= OnNewLap; 
    }

    protected override void Update()
    {
        R3E.Data.Shared data = TelemetryService.Data.Raw;

        //Start mapping of variables  
        SessionPhase = data.SessionPhase;
        FuelRemaining = data.FuelLeft;
        TimeEstimatedLeft = data.SessionTimeRemaining;
        FuelPerLap = data.FuelPerLap;
        LapsEstimatedLeft = data.FuelLeft / data.FuelPerLap;
        SessionLengthFormat = (SessionLengthFormat)data.SessionLengthFormat;


        //Start calculating rest of variables from mapped variables
        //Only on countdown - map the following varibales as a "oneshot" so it doesn't occur throughout the race
        if (SessionPhase == 4)
        {
           oldFuelRemaining = FuelRemaining;
           oldNumberOfLaps = data.NumberOfLaps;
        }

        //Based on the Session Format change the calculations
        switch (SessionLengthFormat)
          {
            case SessionLengthFormat.Unavailable:
            ; //Nothing to calculate
            break;

            // TimeBased
            case SessionLengthFormat.TimeBased: 
            FuelToEnd = (FuelPerLap / data.LapTimeCurrentSelf) * TimeEstimatedLeft;
            FuelToAdd =  Math.Min(FuelToEnd - FuelRemaining, data.FuelCapacity - FuelRemaining); 
            break;

            // LapBased
            case SessionLengthFormat.LapBased:
            FuelToEnd = data.NumberOfLaps / data.FuelPerLap;
            FuelToAdd =  Math.Min(FuelToEnd - FuelRemaining, data.FuelCapacity - FuelRemaining); 
            break;

            // TimeAndLapBased - Time and lap based session means there will be an extra lap after the time has run out
            case SessionLengthFormat.TimeAndLapBased:
            FuelToEnd = (data.NumberOfLaps+1) / data.FuelPerLap;
            FuelToAdd =  Math.Min(FuelToEnd - FuelRemaining, data.FuelCapacity - FuelRemaining);       
            break;
          }      
    }
}