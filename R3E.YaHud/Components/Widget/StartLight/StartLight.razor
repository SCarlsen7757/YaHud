@using R3E.YaHud.Components.Widget.Core
@using R3E.API
@inherits HudWidgetBase<StartLightSettings>

@if (Settings?.Visible ?? false)
{
    <div style="display: @(IsCountdownPhase ? "block" : "none");">
        <div id=@ElementId class="start-light-widget text">
            <div class="lights-and-glows-container" aria-label="Start lights (countdown)">
                <div class="lights-container">
                    @for (int i = 1; i <= 5; i++)
                    {
                        var src = LightColor(i);
                        <div class="light">
                            <R3E.YaHud.Components.Widget.StartLight.Componets.RacingLight IsOn="@src.Item2" ColorHex="@src.Item1" />
                        </div>
                    }
                </div>
                <div class="glows-overlay">
                    @for (int i = 1; i <= 5; i++)
                    {
                        var src = LightColor(i);
                        <div class="glow-wrapper">
                            <div class="glow-layer @(src.Item2 ? "on" : "off")" style="@(src.Item2 ? $"--active-color: {src.Item1};" : "")"></div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {

    private string ImageAssetsBase => "/img/lights/countdown/";

    private string Image(string name)
    {
        return $"{ImageAssetsBase}{name}";
    }

    private int StartLightPhase { get; set; } = 0;
    private R3E.Constant.SessionPhase SessionPhase { get; set; } = R3E.Constant.SessionPhase.Unavailable;
    private DateTime? StartAt { get; set; }

    public override string ElementId { get => "startLightWidget"; }
    public override string Name => "Start light";
    public override string Category => "Telemetry";

    public override double DefaultXPercent => 50;
    public override double DefaultYPercent => 25;

    public override bool Collidable => false;

    public StartLight()
    {
        UseR3EData = true;
        UpdateInterval = TimeSpan.FromMilliseconds(30);
    }

    protected override void Update()
    {
        if (Settings is null) return;
        R3E.Data.Shared data = TelemetryService.Data.Raw;

        StartLightPhase = data.StartLights;
        SessionPhase = (R3E.Constant.SessionPhase)data.SessionPhase;
        StartAt = StartLightPhase == 6 && StartAt is null ? DateTime.UtcNow : StartAt;
    }

    protected override void UpdateWithTestData()
    {
        StartLightPhase = 3;
    }

    private bool IsCountdownPhase => SessionPhase == R3E.Constant.SessionPhase.Countdown || TestMode;

    private bool IsStartPeriodActive()
    {
        if (!TelemetryService.Data.RollingStart) return false;
        if (StartLightPhase < 6) return false;

        if (Settings!.VisibleAfterStartDurationMs > 0 && StartAt != null)
        {
            var elapsed = (DateTime.UtcNow - StartAt.Value).TotalMilliseconds;
            return elapsed <= Settings.VisibleAfterStartDurationMs;
        }
        return StartAt != null;
    }

    private Tuple<string, bool> LightColor(int pos)
    {
        if (IsStartPeriodActive())
        {
            return new(Settings!.StartColor, true);
        }
        if (StartLightPhase <= 0)
        {
            return new("#000000", false);
        }
        if (StartLightPhase >= 1 && StartLightPhase <= 5 && pos <= StartLightPhase)
        {
            return new(Settings!.ReadyColor, true);
        }
        return new("#000000", false);
    }
}
